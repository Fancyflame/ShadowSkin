<!DOCTYPE HTML>
<html>
  <head>
    <!--meta name="theme-color" content=""-->
    <meta content="text/html; charset=utf-8" http-equiv="content-type"/>
    <meta content="user-scalable=0;" name="viewport"  />
    <title>ShadowSkin - Viewer</title>
  </head>
  <noscript>
    <mark style="font-size:60px;color:red;">请使用带JavaScript的浏览器！</mark>                                    
  </noscript>
  <body onload="try{load_();}catch(err){throw err}">
    <style>
      html,body{
        height:100%;
        margin:0;
      }
    </style>
    <script src="pic.js"></script>
    <script src="mobs.js"></script>
    <script src="blocks.js"></script>
    <script src="hframe.js" defer></script>
    <script src="rotateModel.js"></script>
    <!--script src="debugger.js"></script-->
      <script>
      let SKIN_CANVAS;
      let SKIN_INFO={
          name:"creeper",
          source:b64sk.creeper,
          model:"alex"
      }
      let EDITED_TEXTURE=false;
      let HEAD_TEXTURE="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAQCAYAAAB3AH1ZAAADI0lEQVRIDZ1VO28TQRD+9p62E9shLxsCUSICEogGIgqQKEAUCIkCpYiQkKhDxS8gBQUNZTqKdEh0CCgB8agRBQUIIh4JCRgFkzh+3WuPmT02Up5nZSTf7e3MfDM7881aIEUOl3IxmwRhCNuylDWv1Z5nYOLUiFrv9Jh5/VHspON9Yzel1nHAnGPDNjZi2a5UJg1foLfbgn7zulPpyJKDs7QoEcswt8Wefb+a7C8mr4tD3ehyVPG2tdebqRVYL7eMEdOPhVuhKvK/JRpsL+/UBHTfGVxQC0IZbWnFXgJrn9QE2DCgk3NglmyHp/5VaSr7tEdHHODgHNiPpOKB3xIo5jdygXu+VdI50FECpjBUYB3AycaqKvq7E7Jp281vMTroqjSZX0IImkuBjGsiTCpO35LKD1ik86IIEVWBuWCbJmLyMc2kixYVpO1FZE1kJYWeWEMkldrpHtlQAXZkQAYyCMF1THh+knNIulzGRtEWIC2qDR9RLJGhyJ4foR2SL/lwgptF3yO8z3zSwveIxXPtB+RkEACVmtV0BrUnyZgTuTd1Da7tUAIFNBs1OjYl8HMJdx8/R7MVULUkJS7ISygMTkxGAo5N9SPA3e4RgwlmGAZcSkSdgL45Cdc24TgWpq9PQAYCy9U6Fit/8GXpN31LrKzVMHX+tLJhW/aJyJcxGIsxGTvtHkkaKMgwjojlNG5UyhtnjuPWhXHkCLgr4+Lqnft48GoM2cDHSHkQM0/LuDn7DIX+A8qGbdmHfRmDsUCYLGn3yDoJEZuQUlLZbEyePITefBG1oI2BbB7l8hCsTA8evXipQCcvncXC98+Yq1SRdW0U7Ayqa6t4+G6BWheo0+sENAm3u0eYD+JIORez0ia2jo8N49zRYYReE8srK6jWQxws9cGh03z70VDB9WP/UBa1RoC1ekv9EfX39MByc3jzaR5v5+ZVFZhfzAHG1/cI80PfIyqB25dPcPvAABy01N8Hr+2j7vuo/G0Qa2m0qDIDxYKK3aY25NyMWje9NnyagNK+LgwW8zQVMU2BQYSUiGiOGY+FD/Lkw1e11o8rx0ZV4v8AcJp7yreug9gAAAAASUVORK5CYII="
      let SKIN_INFO_BACKUP;
      let MODEL=mobs.alex;
      let CUBESET;
      let GENDER;
      let SELECTED;//选中的部位[cube,face,partName,faceName]
      let SHOWCLO=true;//显示衣服
      const SCENE_OFFSET=-15;
      const DOUBLE=["hat","jacket","leftSleeve","rightSleeve","leftPants","rightPants"]
      const DOUBLE_ELE=[];
      const BONE_NAMES=(function(){
          let raw1="all head body leftArm rightArm leftLeg rightLeg";
          let trans="全身 头 身体 左臂 右臂 左腿 右腿";
          let raw2="all hat jacket leftSleeve rightSleeve leftPants rightPants";
          let dire1="top bottom left right front back";
          let dire2="上面 下面 左边 右边 前面 后面";
          
          let obj={
              human:trans.split(" "),
              a:raw1.split(" "),
              b:raw2.split(" "),
              dire:{}
          };
          dire1.split(" ").forEach((e,i)=>{
              obj.dire[e]=dire2.split(" ")[i];
          })
          /*a1.split(" ").forEach((e,i)=>{
              obj.human[e]=a2.split(" ")[i];
          });
          a2.split(" ").forEach((e,i)=>{
              obj.cloth[e]=b2.split(" ")[i];
          });*/
          return obj;
      })();
      
    function ide(n){
        return document.getElementById(n);
    }
    function getSkinInfo(){
        let m=Object.assign({},SKIN_INFO);
        m=Object.assign(m,{
            texture:SKIN_CANVAS.toDataURL()
        })
        return m;
    }
    
    //加载皮肤
    window.addEventListener("msg",(d)=>{
        d=d.detail;
        let {texture:skin,model:f,name:skinname}=d;
        SKIN_INFO=d;
        let img=new Image();
        img.src=skin;
        img.onload=()=>{
            let cvs=SKIN_CANVAS=document.createElement("canvas");
            cvs.width=img.width;
            cvs.height=img.height;
            let ctx=cvs.getContext('2d');
            ctx.drawImage(img,0,0);
            //let imgdata=ctx.getImageData(0,0,img.width,img.height);
            
            GENDER=f=="steve";
            changeArm();
            ide("skinname").innerText=skinname;
            SKIN_INFO_BACKUP=JSON.stringify(d);
        
            //恢复默认
            {
                document.querySelector("[index=_0]").click();
                let clo=ide("showClothes");
                clo.setAttribute("selected","true");
                clo.click();
            }
        }
        CUBESET.forEach((e,i)=>{
            e.texture=skin;
        });
    })
    
    function hasEditedSkin(ch){
        if(ch===false){
            SKIN_INFO_BACKUP=JSON.stringify(SKIN_INFO);
            EDITED_TEXTURE=false;
        }
        return EDITED_TEXTURE||(JSON.stringify(SKIN_INFO)!=SKIN_INFO_BACKUP);
    }
    
    //卸载皮肤
    function goback(save){
        if(!save&&hasEditedSkin()){
            if(!confirm("您已修改，确定不保存吗？"))return;
        }
        HFrame.send({
            event:"close",
            save:save?getSkinInfo():false
        })
        //alert(JSON.stringify(getSkinInfo()))
    }
    
    //选择面编辑
    function selectEdit(cube,face){
          face.cancelBubble=true;
          if(SELECTED){
              SELECTED[1]=face;
              edit();
          }else{
              let p=BONE_NAMES[SHOWCLO?"b":"a"];
              for(let i in p){
                  if(p[i]==cube.name){
                      //查找对应的按钮并按下
                      let b=ide("selectPartBar").querySelector("[index=_"+i+"]");
                      b.click();
                      break;
                  }
              }
              SELECTED=[cube];
          }
      }
    
    //功能按钮
    
    //选择手臂粗细
    function changeArm(event){
        if(event){
            GENDER=!GENDER;
        }
        let ev=ide("selectGender");
        let b=GENDER;
        ev.innerText=b?"男生":"女生";
        ev.setAttribute("color",b?"deepskyblue":"lightpink");
        selectChange(ev);
        let m=mobs[b?"steve":"alex"];
        
        if(!CUBESET)return;
        function foo(n){
            let a=m[n];
            let q=CUBESET.children[n];
            q.size=[a.size[0],a.size[1],a.size[2]];
            q.uv=a.uv;
            q.Position=a.origin.map((e,ind)=>{
                //e*=10;
                e+=a.size[ind]/2;
                if(ind==1)e*=-1;
                return e;
            });
            if(!SELECTED)q.position=q.Position;
            q.texture=q.texture;
        }
        foo("leftArm");
        foo("rightArm");
        foo("leftSleeve");
        foo("rightSleeve");
        SKIN_INFO.model=b?"steve":"alex";
        try{
        if(SELECTED)SELECTED[0].View()
        }catch(err){alert(err)}
    }
    
    //显示衣物
    function showClothes(ev){
        let div=ev.target;
        let l=selectChange(div,true);
        SHOWCLO=l;
        DOUBLE_ELE.forEach((e)=>{
            e.element.style.display=l?"":"none";
        });
        selectPart(ide("selectPartBar").querySelector("[selected=true]"));
    }
    
    //选择身体部位
    function selectPart(ev){
        let div=ev.target||ev;
        div.setAttribute("selected","true");
        selectChange(div);
        Array.from(ide("selectPartBar").children).forEach((e)=>{
            if(e!=div){
                e.setAttribute("selected","false");
                selectChange(e);
            }
        });
        let index=parseInt(div.getAttribute("index").slice(1));
        index=BONE_NAMES[SHOWCLO?"b":"a"][index];
        let cube=CUBESET.children[index];
        
        //上一个不是全部显示
        if(SELECTED){
            CUBESET.forEach((e)=>{
                e.Reset();
            })
        }
        
        //这次全部显示
        if(!cube){
            SELECTED=null;
        }else{
            CUBESET.forEach((e)=>{
                e.element.style.display="none";
            })
            cube.View();
            SELECTED=[cube,null,index];
        }
    }
    
    //加载或点击圆形开关按钮
    function selectChange(div,rev){
        let a=div.getAttribute("color");
        let b=selectChange.check(div);
        if(rev){
            b=!b;
            div.setAttribute("selected",b);
        }
        let s=div.style;
        s.background=b?a:"rgba(0,0,0,0)";
        s.border=b?"0px":"2px solid "+a;
        s.color=b?"white":a;
        return b;
    }
    selectChange.check=function(ele){
        return ele.getAttribute("selected")=="true";
    }
    
    //编辑皮肤
    function edit(){
        //ev.preventDefault();
        let e=ide("editor");
        e.fullScreen=true;
        let face=SELECTED[1];
        let picture=(function(){
            let cvs=document.createElement("canvas");
            let ctx=cvs.getContext('2d');
            let d=SKIN_CANVAS.getContext("2d").getImageData(
                face.uv[0],face.uv[1],
                face.size[0],face.size[1]
            );
            cvs.width=d.width;
            cvs.height=d.height;
            ctx.putImageData(d,0,0);
            return cvs.toDataURL();
        })();
        let texture;
        e.send({
            texture:picture,
            name:face.name,
            editor:SKIN_INFO.editor
        });
        e.addEventListener("msg",(d)=>{
            d=d.detail;
            switch(d.event){
                case "close":
                    if(d.save){
                        let ctx=SKIN_CANVAS.getContext('2d');
                        let img=new Image();
                        img.src=d.save.code;
                        SKIN_INFO.editor=d.save.editor;
                        img.onload=()=>{
                            let uv=face.uv;
                            ctx.clearRect(uv[0],uv[1],img.width,img.height);
                            ctx.drawImage(img,uv[0],uv[1]);
                            SELECTED[0].texture=SKIN_CANVAS.toDataURL();
                            EDITED_TEXTURE=true;
                        }
                    }
                    e.fullScreen=false;
                    break;
            }
        },{once:true})
    }
    
    
    function load_(){
        //第一次载入皮肤
        {
            let setSize=function(){
                window.removeEventListener("msg",setSize);
                CUBESET.transform.translate([
                    (ide("camera").clientWidth/40),
                    (ide("camera").clientHeight/40),
                    0
                ]);
            }
            window.addEventListener("msg",setSize);
            let e=ide("editor");
            /*e.addEventListener("msg",(d)=>{
                d=d.detail;
                switch(d.event){
                    case "close":
                        e.fullScreen=false;
                        break;
                }
            })*/
        }
            
        let cubeset=new blocky.CubeSet(ide("scene"));
        
        for(let name in MODEL){
            let {origin,size,uv,inflate=0}=MODEL[name];
            origin=origin.map((e,ind)=>{
              //e*=10;
              e+=size[ind]/2;
              if(ind==1)e*=-1;
              return e;
            });
            
            let c=new blocky.Cube({
                uv:uv,
                transform:{
                    position:origin,
                    scale:size.map((x)=>{
                        return inflate?1.1:1
                    })
                },
                size:size,
                name:name
            });
            c.transform.update();
            c.IsClothes=Boolean(inflate);
            //恢复原样时
            c.Reset=()=>{
                c.position=c.Position||origin;
                c.scale=inflate?1.1:1;
                let sc=c.IsClothes?(SHOWCLO?"":"none"):"";
                c.element.style.display=sc;
                c.Viewing=false;
            }
            //选中编辑时
            c.View=()=>{
                c.element.style.display="";
                c.position=[0,SCENE_OFFSET,0];
                c.scale=1.8;
                c.Viewing=true;
            }
            c.element.setAttribute("tabindex","1")
            for(let i in c.faces){
                let q=c.faces[i];
                q.setAttribute("tabindex","2")
                q.onclick=(ev)=>{
                    selectEdit(c,ev.target);
                }
            }
            cubeset.add(c);
            if(DOUBLE.includes(name)){
                DOUBLE_ELE.push(c);
            }
            
            /*setTimeout(()=>{
                c.texture=b64sk.alex;
            },5000)*/
        }
        {
            let s=cubeset.element.style;
            s.position="absolute"
            s.margin="0 auto";
        
            s["transform-origin"]="0px "+SCENE_OFFSET+"px";
            s["image-rendering"]="pixelated"
        }
        cubeset.transform.scale(Array(3).fill(20));
        CUBESET=cubeset;
        
        let handle=addTouchHandle(ide("camera"),cubeset.element);
        
        //方向提示
        let viewHint;
        {
            viewHint=new blocky.Cube({
                size:[8,8,8],
                texture:HEAD_TEXTURE,
                uv:[0,0],
                transform:{
                    scale:[10,10,10]
                }
            });
            let s=viewHint.element.style;
            s.position="absolute";
            s["image-rendering"]="pixelated";
            s.right="10vw";
            s.top="30vh";
            document.body.insertBefore(viewHint.element,ide("editor"));
        }
        
        handle.ontransform=(s)=>{
            cubeset.transform.remove("rotate");
            cubeset.transform.addRaw(s,"rotate");
            viewHint.transform.remove("rotate");
            viewHint.transform.addRaw(s,"rotate");
            viewHint.updateTransform();
        }
        handle.limitLock=true;
        
        
        document.body.querySelectorAll(".circle").forEach((e)=>{
            selectChange(e);
            
        });
        {
            let bar=ide("selectPartBar")
            let h=BONE_NAMES;
            h.human.forEach((e,i)=>{
                let d=document.createElement("button");
                d.onclick=selectPart;
                d.className="circle";
                let attr={
                    color:"yellowgreen",
                    selected:i==0?"true":"false",
                    index:"_"+i
                }
                for(let i in attr){
                    d.setAttribute(i,attr[i]);
                }
                d.innerText=e;
                selectChange(d);
                bar.appendChild(d);
            });
        }
    }
    
    //改名操作
    function skinname_input(ev){
        let g=ev.target;
        if(g.length>10)return false;
        if(/[\r\n]/.test(ev.data))return false;
        SKIN_INFO.name=ev.target.innerText;
    }
    
    //文件操作
    function skinsave(){
        hasEditedSkin(false);
        HFrame.send({
            event:"save",
            save:getSkinInfo()
        });
    }
    function skincopy(){
        let name=prompt("新皮肤名称",SKIN_INFO.name+"-副本");
        if(name===null)return;
        HFrame.send({
            event:"copy",
            name:name
        });
    }
    function skindelete(){
        if(confirm("确定删除皮肤吗？")&&(!confirm("按“取消”键删除"))){
            HFrame.send({
                event:"delete"
            })
        }
    }
    function skindownload(proj){
        if(hasEditedSkin()){
            if(!confirm("将保存当前更改并下载皮肤"))return;
            skinsave();
        }
        let da;
        if(proj){
            da=JSON.stringify(getSkinInfo());
            da=URL.createObjectURL(new Blob([da],{type:"application/octet-stream"}));
        }else{
            da=getSkinInfo().texture;
            da=da.slice(da.indexOf(",")+1);
            da="data:application/octet-stream;base64,"+da;
        }
        let a=ide("a");
        a.download=SKIN_INFO.name+(proj?".json":".png");
        a.href=da;
        a.click();
    }
    </script>
    <style>
      *{
          outline:none;
          font-size:30px;
          font-family:sans-serif;
      }
      #camera{
        width:100%;
        height:70%;
        box-sizing:border-box;
        flex-shrink:0;
        perspective:1500px;
        background-color:aliceblue;
      }
      #scene{
       position:absolute;
        /*border:5px solid black;*/
        transform-origin:top center;
        display:grid;
      }
      #selectPartBar,#headbar{
        width:100%;
        height:20%;
        flex-shrink:1;
        box-shadow:0px 2px 7px 4px grey;
      }
      #headbar{
          background-color:yellowgreen;
          text-align:center;
          font-size:130px;
          min-height:100px;
          color:white;
          display:grid;
          grid-template-columns:1fr 4fr 1fr;
      }
      #headbar > a{
          font-size:50px;
          display:block;
          margin:auto 0;
          text-shadow:0px 0px 8px white;
      }
      #headbar > div{
          font-size:110px;
          font-weight:bold;
          text-shadow:0px 2px 5px grey;
          margin:auto 0;
      }
      #selectPartBar{
        display:flex;
        background:aliceblue;
        justify-content:space-around;
      }
      body{
        display:flex;
        flex-direction:column;
        overflow:hidden;
      }
      .circle{
        border-radius:100%;
        height:100px;
        width:100px;
        overflow:hidden;
        margin:2px;
        white-space:nowrap;
        border-style:outset;
      }
      .circle:active{
          border-style:inset;
      }
      #leftbar,#rightbar{
          position:absolute;
          display:flex;
          flex-direction:column;
          justify-content:center;
          height:80%;
          top:10%;
          margin:10px;
      }
      #rightbar{
          right:0%;
      }
      
      #editSkin{
          border-radius:20px;
          width:50%;
          box-shadow:0px 0px 15px 15px cyan;
          background:dodgerblue;
          color:white;
          border:none;
          height:100px;
          font-size:50px;
          transform:translate(50%,0);
          position:absolute;
          margin:50px 0;
      }
      #editor{
          display:none;
      }
    </style>
    <div id="headbar">
        <a style="color:red" onclick="goback(false)">返回</a>
        <div contenteditable="true" oninput="skinname_input(event)" id="skinname"></div>
        <a style="color:dodgerblue" onclick="goback(true)">保存</a>
    </div>
    <div id="camera" tabindex="10" >
      <button id="editSkin" style="display:none" onmousedown="edit(event)">EDIT</button>
      <div id="scene" tabindex="1"></div>
      
      <div id="leftbar">
        <button id="showClothes" onclick="showClothes(event)" color="dodgerblue" selected="false" class="circle">衣饰</button>
        <button id="selectGender" onclick="changeArm(event)" color="deepskyblue" isBoy="true" selected="true" class="circle"></button>
      </div>
      
      <div id="rightbar">
          <button id="skinsave" onclick="skinsave()" class="circle" color="dodgerblue" selected="true">保存</button>
          <button id="skinoutput" onclick="skindownload(true)" class="circle" color="dodgerblue" selected="false">导出</button>
          <button id="skindownload" onclick="skindownload()" class="circle" color="dodgerblue" selected="false">下载</button>
          <button id="skincopy" onclick="skincopy()" class="circle" color="dodgerblue" selected="false">复制</button>
          <button id="skindelete" onclick="skindelete()" class="circle" color="red" selected="false">删除</button>
      </div>
    </div>
    <div id="selectPartBar"></div>
    <h-frame id="editor" src="editor.html"></h-frame>
    <a id="a"></a>
  </body>
</html>
